class AthanTimesExtension{constructor(){this.currentLocation=null;this.prayerTimes=null;this.countdownInterval=null;this.init()}init(){this.bindEvents();this.updateDates();this.loadSavedLocation()}bindEvents(){}updateDates(){const e=new Date,t=e.toLocaleDateString("ar-SA",{weekday:"long",year:"numeric",month:"long",day:"numeric"});document.getElementById("gregorian-date").textContent=t,this.getHijriDate(e)}async getHijriDate(e){try{const t=await fetch(`https://api.aladhan.com/v1/gToH/${e.getDate()}-${e.getMonth()+1}-${e.getFullYear()}`),a=await t.json();if(200===a.code){const e=a.data.hijri,t=`${e.day} ${e.month.ar} ${e.year} هـ`;document.getElementById("hijri-date").textContent=t}}catch(e){console.error("Error fetching Hijri date:",e),document.getElementById("hijri-date").textContent="التقويم الهجري"}}showLoading(){document.getElementById("loading").classList.remove("hidden"),document.getElementById("error").classList.add("hidden"),document.getElementById("prayer-times").style.opacity="0.5"}hideLoading(){document.getElementById("loading").classList.add("hidden"),document.getElementById("prayer-times").style.opacity="1"}showError(e="لا يمكن جلب أوقات الصلاة. يرجى المحاولة مرة أخرى."){document.getElementById("error").classList.remove("hidden"),document.getElementById("error").querySelector("p").textContent=e,this.hideLoading()}hideError(){document.getElementById("error").classList.add("hidden")}getCurrentLocation(){this.showLoading(),this.hideError(),navigator.geolocation?navigator.geolocation.getCurrentPosition(async e=>{const{latitude:t,longitude:a}=e.coords;try{let e="الموقع الحالي";try{const r=await fetch(`https://api.aladhan.com/v1/latLngToAddress/${t}/${a}`),n=await r.json();200===n.code&&n.data&&(n.data.city?e=n.data.city:n.data.locality?e=n.data.locality:n.data.state?e=n.data.state:n.data.country&&(e=n.data.country))}catch(e){console.error("Aladhan API error:",e)}if("الموقع الحالي"===e)try{const r=await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${t}&longitude=${a}&localityLanguage=ar`),n=await r.json();n.city?e=n.city:n.locality?e=n.locality:n.principalSubdivision?e=n.principalSubdivision:n.countryName&&(e=n.countryName)}catch(e){console.error("Alternative API error:",e)}this.currentLocation={latitude:t,longitude:a,city:e},this.saveLocation(this.currentLocation),this.updateLocationDisplay(),await this.fetchPrayerTimes(t,a)}catch(e){console.error("Error getting location details:",e),this.currentLocation={latitude:t,longitude:a,city:"الموقع الحالي"},await this.fetchPrayerTimes(t,a)}},e=>{console.error("Geolocation error:",e),this.showError("لا يمكن الوصول إلى موقعك. يرجى السماح بالوصول للموقع.")}):this.showError("تحديد الموقع الجغرافي غير مدعوم في هذا المتصفح.")}async fetchPrayerTimes(e,t){try{const a=new Date,r=`${a.getDate()}-${a.getMonth()+1}-${a.getFullYear()}`,n=await fetch(`https://api.aladhan.com/v1/timings/${r}?latitude=${e}&longitude=${t}&method=4`),i=await n.json();200===i.code?(this.prayerTimes=i.data.timings,this.updatePrayerTimesDisplay(),this.startCountdown(),this.hideLoading()):this.showError("لا يمكن جلب أوقات الصلاة لهذا الموقع.")}catch(e){console.error("Error fetching prayer times:",e),this.showError("خطأ في جلب أوقات الصلاة. يرجى التحقق من اتصالك بالإنترنت.")}}updatePrayerTimesDisplay(){if(!this.prayerTimes)return;["Fajr","Sunrise","Dhuhr","Asr","Maghrib","Isha"].forEach(e=>{const t=document.getElementById(`${e.toLowerCase()}-time`);if(t&&this.prayerTimes[e]){const a=this.prayerTimes[e],r=this.convertTo12Hour(a);t.textContent=r}}),this.highlightCurrentPrayer()}convertTo12Hour(e){const[t,a]=e.split(":"),r=parseInt(t),n=r>=12?"مساءً":"صباحاً",i=r%12||12;return`${i}:${a} ${n}`}highlightCurrentPrayer(){if(!this.prayerTimes)return;const e=new Date,t=60*e.getHours()+e.getMinutes(),a=[{name:"Fajr",time:this.prayerTimes.Fajr},{name:"Sunrise",time:this.prayerTimes.Sunrise},{name:"Dhuhr",time:this.prayerTimes.Dhuhr},{name:"Asr",time:this.prayerTimes.Asr},{name:"Maghrib",time:this.prayerTimes.Maghrib},{name:"Isha",time:this.prayerTimes.Isha}];a.forEach(e=>{const[t,a]=e.time.split(":");e.timeInMinutes=60*parseInt(t)+parseInt(a)});let r=-1;for(let e=0;e<a.length-1;e++)if(t>=a[e].timeInMinutes&&t<a[e+1].timeInMinutes){r=e;break}-1===r&&(t>=a[a.length-1].timeInMinutes||t<a[0].timeInMinutes)&&(r=a.length-1),document.querySelectorAll(".prayer-item").forEach(e=>{e.classList.remove("active")});if(r>=0){const e=a[r].name.toLowerCase(),t=document.getElementById(`${e}-time`).closest(".prayer-item");t&&t.classList.add("active")}}startCountdown(){this.countdownInterval&&clearInterval(this.countdownInterval),this.updateCountdown(),this.countdownInterval=setInterval(()=>{this.updateCountdown()},1e3)}updateCountdown(){if(!this.prayerTimes)return;const e=new Date,t=60*e.getHours()+e.getMinutes(),a=[{name:"Fajr",time:this.prayerTimes.Fajr},{name:"Dhuhr",time:this.prayerTimes.Dhuhr},{name:"Asr",time:this.prayerTimes.Asr},{name:"Maghrib",time:this.prayerTimes.Maghrib},{name:"Isha",time:this.prayerTimes.Isha}];let r=null,n=1/0;if(a.forEach(e=>{const[a,i]=e.time.split(":"),o=60*parseInt(a)+parseInt(i);let s=o-t;s<=0&&(s+=1440),s<n&&(n=s,r=e)}),r){const t=Math.floor(n/60),a=n%60,i=60-e.getSeconds(),o={Fajr:"الفجر",Dhuhr:"الظهر",Asr:"العصر",Maghrib:"المغرب",Isha:"العشاء"};document.getElementById("next-prayer-name").textContent=o[r.name]||r.name,document.getElementById("next-prayer-countdown").textContent=`${t.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}}updateLocationDisplay(){this.currentLocation&&(document.getElementById("current-location").textContent=this.currentLocation.city)}saveLocation(e){chrome.storage.local.set({location:e})}saveCalculationMethod(e){chrome.storage.local.set({calculationMethod:e})}async loadSavedLocation(){try{this.getCurrentLocation()}catch(e){console.error("Error getting current location:",e);try{const e=await chrome.storage.local.get(["location"]);e.location&&(this.currentLocation=e.location,this.updateLocationDisplay(),await this.fetchPrayerTimes(e.location.latitude,e.location.longitude))}catch(e){console.error("Error loading saved location:",e)}}}}document.addEventListener("DOMContentLoaded",()=>{new AthanTimesExtension});